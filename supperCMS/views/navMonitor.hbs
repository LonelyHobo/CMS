<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
	<legend>菜单设置</legend>
</fieldset>
<link rel="stylesheet" href="/plus/jquerytree/css/font-awesome.min.css" />
<link rel="stylesheet" href="/plus/jquerytree/css/tree.css" />
<div style="padding: 20px; background-color: #F2F2F2;">
	<div class="layui-row layui-col-space15">
		<div class="layui-col-md6">
			<div class="layui-card">
				<div class="layui-card-header">菜单结构</div>
				<div class="layui-card-body">
					<div id="navList"></div>
				</div>
			</div>
		</div>
		<div class="layui-col-md6">
			<div class="layui-card">
				<div class="layui-card-header">菜单详情</div>
				<div class="layui-card-body">
					<div class="layui-form" lay-filter="navform">
						<input type="hidden" name="id" id="id" value="" />
						<div class="layui-form-item">
							<div class="layui-inline">
								<label class="layui-form-label">菜单名称</label>
								<div class="layui-input-inline">
									<input type="text" name="nav-name" autocomplete="off" class="layui-input" value="">
								</div>
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-inline">
								<label class="layui-form-label">菜单级别</label>
								<div class="layui-input-inline">
									<input type="text" name="nav-rank" disabled="disabled" autocomplete="off" class="layui-input" value="">
								</div>
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-inline">
								<label class="layui-form-label">菜单分类</label>
								<div class="layui-input-inline">
									<input type="text" name="nav-class" disabled="disabled" autocomplete="off" class="layui-input" value="">
								</div>
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-inline">
								<label class="layui-form-label">父级菜单</label>
								<div class="layui-input-inline">
									<select name="nav-parent" lay-filter="nav-parent" class="layui-input">
										<option value="0">无</option>
									</select>
								</div>
							</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">是否显示</label>
							<div class="layui-input-block">
								<input type="radio" name="nav-show" value="1" title="是">
								<input type="radio" name="nav-show" value="0" title="否">
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-input-block">
								<button class="layui-btn" lay-submit="save" lay-filter="save">保存</button>
								<button class="layui-btn" lay-submit="del" lay-filter="del">删除</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="/plus/jquerytree/js/proTree.js"></script>
<script type="text/javascript">
	var navdata=[];
	$.ajax({
		type: "post",
		url: "/users/navdata",
		async: true,
		success: function(data) {
			if(data.state == 200) {
				var data_=[];
				$.each(data.data, function(index) {
					var jsons = {
						id: this.id,
						name: this.nav_name,
						pid: this.nav_parent,
						class: this.nav_class,
						rank: this.nav_rank,
						show: this.nav_show
					};
					data_.push(jsons);
					navdata[this.id]=jsons;
				})
				$.each(data_,function(){
					$('select[name="nav-parent"]').append('<option value="'+this.id+'" data-class="'+this.class+'" data-rank="'+this.rank+'">'+this.name+'('+this.rank+'级)</option>');
				});
				$("#navList").ProTree({
					arr: data_,
					close: true,
					simIcon: "fa fa-file-o", //单个标题字体图标 不传默认glyphicon-file
					mouIconOpen: "fa fa-folder-open-o", //含多个标题的打开字体图标  不传默认glyphicon-folder-open
					mouIconClose: "fa fa-folder-o", //含多个标题的关闭的字体图标  不传默认glyphicon-folder-close
					callback: formchange
				})
			} else {
				layer.msg(data.marked, {
					icon: 2,
					time: 1000
				});
			}
		},
		error: function(data) {
			console.log(data);
		}
	});
	var formchange=function(id){
		form_.val('navform', {
			"nav-name":navdata[id].name,
			"nav-rank": navdata[id].rank,
			"nav-class":navdata[id].class,
			"nav-show": navdata[id].show+'',
			"nav-parent":navdata[id].pid,
			"id":navdata[id].id
		});
		var p = $('select[name="nav-parent"]').parent();
		if(navdata[id].pid==0)$('input[name="nav-class"]').attr('disabled',false);
		p.find('dl dd').show();
		p.find('dl dd[lay-value="'+navdata[id].id+'"]').hide();
	};
	var form_;
	layui.use(['form', 'layedit', 'laydate'], function() {
		var form = layui.form,
			layer = layui.layer,
			layedit = layui.layedit,
			laydate = layui.laydate;

		//监听提交
		form.on('submit(save)', function(data) {
			$.ajax({
				type: "post",
				url: "/users/navedit",
				async: true,
				data: data.field,
				success: function(data) {
					if(data.state == 200) {
						layer.msg(data.marked, {
							icon: 1,
							time: 1000
						}, function() {
							location.href = '/{{href}}'
						});
					} else if(data.state == 500) {
						layer.msg(data.marked, {
							icon: 2,
							time: 1000
						}, function() {
							location.href = '/{{href}}'
						});
					}
				},
				error: function(data) {
					console.log(data);
				}
			});
		});
		form.on('submit(del)', function(data) {
			
		});
		form.on('select(nav-parent)', function(data){
			if(data.value != '0'){
				$('input[name="nav-class"]').val($(data.elem).find('option[value="'+data.value+'"]').attr('data-class')).attr('disabled',true);
				$('input[name="nav-rank"]').val($(data.elem).find('option[value="'+data.value+'"]').attr('data-rank'));
			}else{
				$('input[name="nav-rank"]').val('1');
				$('input[name="nav-class"]').val('').attr('placeholder','请输入分类').attr('disabled',false);
			}
		})
		//表单初始赋值
		form_=form;
	});
</script>